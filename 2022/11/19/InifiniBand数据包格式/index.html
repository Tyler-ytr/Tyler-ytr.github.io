<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE) | Tyler-yin&#39;s blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="RDMA">
    <meta name="description" content="InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)本部分来自于对于IB Specification Vol 1-Release-1.5-2021-08-06b中的CHAPTER 5: DATA PACKET FORMAT以及ANNEX A16: RDMA OVER CONVERGED ETHERNET (ROCE)和ANNEX A17: ROCEV2">
<meta property="og:type" content="article">
<meta property="og:title" content="InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)">
<meta property="og:url" content="http://tyler-ytr.github.io/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/index.html">
<meta property="og:site_name" content="Tyler-yin&#39;s blog">
<meta property="og:description" content="InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)本部分来自于对于IB Specification Vol 1-Release-1.5-2021-08-06b中的CHAPTER 5: DATA PACKET FORMAT以及ANNEX A16: RDMA OVER CONVERGED ETHERNET (ROCE)和ANNEX A17: ROCEV2">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221119205620311.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221119205946201.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221119210357384.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221119210409675.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120151139851.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120151522089.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120153533606.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120154114790.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120154520472.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120155040687.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120155521892.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120155612468.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120161302307.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120161926327.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120162322487.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120162703075.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221120163518952.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221119204506174.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221119200915736.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221119201022846.png">
<meta property="og:image" content="http://tyler-ytr.github.io/picture/image-20221119202229290.png">
<meta property="article:published_time" content="2022-11-19T11:01:45.000Z">
<meta property="article:modified_time" content="2022-11-20T08:43:41.853Z">
<meta property="article:author" content="Tyler-yin">
<meta property="article:tag" content="RDMA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://tyler-ytr.github.io/picture/image-20221119205620311.png">
    
        <link rel="alternate" type="application/atom+xml" title="Tyler-yin&#39;s blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/Tyler.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Tyler-yin</h5>
          <a href="mailto:ytrpossible@gmail.com" title="ytrpossible@gmail.com" class="mail">ytrpossible@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Index
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/Tyler-ytr/" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/friends"  >
                <i class="icon icon-lg icon-address-book"></i>
                Friends
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-link"></i>
                link
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)</h1>
        <h5 class="subtitle">
            
                <time datetime="2022-11-19T11:01:45.000Z" itemprop="datePublished" class="page-time">
  2022-11-19
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93/">个人总结</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#InfiniBand-数据包格式，ROCE-以及ROCEV2-IP-ROUTABLE-ROCE"><span class="post-toc-number">1.</span> <span class="post-toc-text">InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#CHAPTER-5：数据包格式"><span class="post-toc-number">2.</span> <span class="post-toc-text">CHAPTER 5：数据包格式</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#数据包类型"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">数据包类型</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#数据包格式"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">数据包格式</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#LOCAL-ROUTE-HEADER-LRH-8-Bytes"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">LOCAL ROUTE HEADER(LRH)-8 Bytes</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Global-Route-Header-GRH-40-Bytes"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">Global Route Header(GRH)-40 Bytes</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Base-Transport-Header-BTH-12-Bytes"><span class="post-toc-number">2.2.3.</span> <span class="post-toc-text">Base Transport Header(BTH)-12 Bytes</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Reliable-Datagram-Extended-Transport-header-RDETH-4-Bytes"><span class="post-toc-number">2.2.4.</span> <span class="post-toc-text">Reliable Datagram Extended Transport header(RDETH)-4 Bytes</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#RDMA-Extended-transport-header-RETH-16-Bytes"><span class="post-toc-number">2.2.5.</span> <span class="post-toc-text">RDMA Extended transport header(RETH)-16 Bytes</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Atomic-Extended-Transport-Header-AtomicETH-28-Bytes"><span class="post-toc-number">2.2.6.</span> <span class="post-toc-text">Atomic Extended Transport Header(AtomicETH)-28 Bytes</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#XRC-Extended-Transport-Header-XRCETH"><span class="post-toc-number">2.2.7.</span> <span class="post-toc-text">XRC Extended Transport Header(XRCETH)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ACK-Extended-Transport-Header-AETH-4-Bytes"><span class="post-toc-number">2.2.8.</span> <span class="post-toc-text">ACK Extended Transport Header(AETH)-4 Bytes</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Atomic-ACK-Extended-Transport-Header-AtomicAckETH-8-Bytes"><span class="post-toc-number">2.2.9.</span> <span class="post-toc-text">Atomic ACK Extended Transport Header(AtomicAckETH)-8 Bytes</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Immediate-Data-Extended-Transport-Header-ImmDt-4-Bytes"><span class="post-toc-number">2.2.10.</span> <span class="post-toc-text">Immediate Data Extended Transport Header(ImmDt)-4 Bytes</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Invalidate-Extended-Transport-Header-IETH-4-Bytes"><span class="post-toc-number">2.2.11.</span> <span class="post-toc-text">Invalidate Extended Transport Header(IETH)-4 Bytes</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Payload"><span class="post-toc-number">2.2.12.</span> <span class="post-toc-text">Payload</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Invariant-CRC"><span class="post-toc-number">2.2.13.</span> <span class="post-toc-text">Invariant CRC</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Variant-CRC"><span class="post-toc-number">2.2.14.</span> <span class="post-toc-text">Variant CRC</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Raw-Packets"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">Raw Packets</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#IBA-Packets-案例"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">IBA Packets 案例</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#ANNEX-A16：RoCE协议"><span class="post-toc-number">3.</span> <span class="post-toc-text">ANNEX A16：RoCE协议</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#RoCE协议的目标"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">RoCE协议的目标</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#RoCE格式"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">RoCE格式</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#ANNEX-A17：RoCEv2"><span class="post-toc-number">4.</span> <span class="post-toc-text">ANNEX A17：RoCEv2</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#RoCE简介"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">RoCE简介</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#RoCEv2（IP-Routable-RoCE）"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">RoCEv2（IP Routable RoCE）</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">参考</span></a></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-InifiniBand数据包格式"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)</h1>
        <div class="post-meta">
            <time class="post-time" title="2022-11-19 19:01:45" datetime="2022-11-19T11:01:45.000Z"  itemprop="datePublished">2022-11-19</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93/">个人总结</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="InfiniBand-数据包格式，ROCE-以及ROCEV2-IP-ROUTABLE-ROCE"><a href="#InfiniBand-数据包格式，ROCE-以及ROCEV2-IP-ROUTABLE-ROCE" class="headerlink" title="InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)"></a>InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)</h1><p>本部分来自于对于IB Specification Vol 1-Release-1.5-2021-08-06b中的CHAPTER 5: DATA PACKET FORMAT以及ANNEX A16: RDMA OVER CONVERGED ETHERNET (ROCE)和ANNEX A17: ROCEV2 (IP ROUTABLE ROCE)的整理；</p>
<h1 id="CHAPTER-5：数据包格式"><a href="#CHAPTER-5：数据包格式" class="headerlink" title="CHAPTER 5：数据包格式"></a>CHAPTER 5：数据包格式</h1><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221119205620311.png" alt="IBA communication Stack" title="">
                </div>
                <div class="image-caption">IBA communication Stack</div>
            </figure>
<p>在IB协议中，message被分段成数据包然后在Fabric中传输；</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221119205946201.png" alt="IBA messages to packets" title="">
                </div>
                <div class="image-caption">IBA messages to packets</div>
            </figure>
<h2 id="数据包类型"><a href="#数据包类型" class="headerlink" title="数据包类型"></a>数据包类型</h2><p>数据包有以下类型：</p>
<ol>
<li>不可分割的数据传输和路由单元</li>
<li>确认单元</li>
<li>消息分段和重组单元</li>
<li>链路级流控制单元</li>
</ol>
<p>另外可以分为：</p>
<ol>
<li>IBA Packets，包含了IBA transport headers</li>
<li>Raw Packets，不包含IBA transport headers但是可以在IBA结构上路由。我的理解是这是IB结构对于其他数据包的兼容。</li>
</ol>
<h2 id="数据包格式"><a href="#数据包格式" class="headerlink" title="数据包格式"></a>数据包格式</h2><p>在transport header以及payload之前有两个路由头：</p>
<ol>
<li>local route header对于所有包都是需要的</li>
<li>global route header对于要路由到不同子网的所有数据包以及所有组播数据包是必要的</li>
<li>global route header可以放置在除了子网管理数据包(subnet management packets)之外的任何数据包上</li>
</ol>
<p>InfiniBand设备生成的数据包应该符合下面两图的结构以及大小位置要求；</p>
<p>另外IBA数据包(IBA Packets)的结尾是一个非变体CRC然后是一个变体CRC;Raw Packets结尾是一个变体CRC。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221119210357384.png" alt="IBA数据包简介" title="">
                </div>
                <div class="image-caption">IBA数据包简介</div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221119210409675.png" alt="完整版本的IBA数据包格式" title="">
                </div>
                <div class="image-caption">完整版本的IBA数据包格式</div>
            </figure>
<h3 id="LOCAL-ROUTE-HEADER-LRH-8-Bytes"><a href="#LOCAL-ROUTE-HEADER-LRH-8-Bytes" class="headerlink" title="LOCAL ROUTE HEADER(LRH)-8 Bytes"></a>LOCAL ROUTE HEADER(LRH)-8 Bytes</h3><p>LRH用于在IBA子网内部的本地路由</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120151139851.png" alt="LRH" title="">
                </div>
                <div class="image-caption">LRH</div>
            </figure>
<h3 id="Global-Route-Header-GRH-40-Bytes"><a href="#Global-Route-Header-GRH-40-Bytes" class="headerlink" title="Global Route Header(GRH)-40 Bytes"></a>Global Route Header(GRH)-40 Bytes</h3><p>GRH用于在子网之间的路由。GRH是否存在由上面的LRH中的LNH字段指示。GRH的布局与RFC2460中的IPv6头部一致（但是要注意这里没有定义GID与IPv6之间的映射）。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120151522089.png" alt="GRH" title="">
                </div>
                <div class="image-caption">GRH</div>
            </figure>
<h3 id="Base-Transport-Header-BTH-12-Bytes"><a href="#Base-Transport-Header-BTH-12-Bytes" class="headerlink" title="Base Transport Header(BTH)-12 Bytes"></a>Base Transport Header(BTH)-12 Bytes</h3><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120153533606.png" alt="BTH_1" title="">
                </div>
                <div class="image-caption">BTH_1</div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120154114790.png" alt="BTH_2" title="">
                </div>
                <div class="image-caption">BTH_2</div>
            </figure>
<p>BTH是否存在由上一个header的”下一个标头”字段表示(LRH:LNH or GRH:NextHdr)；</p>
<p>细节部分见9.2。</p>
<h3 id="Reliable-Datagram-Extended-Transport-header-RDETH-4-Bytes"><a href="#Reliable-Datagram-Extended-Transport-header-RDETH-4-Bytes" class="headerlink" title="Reliable Datagram Extended Transport header(RDETH)-4 Bytes"></a>Reliable Datagram Extended Transport header(RDETH)-4 Bytes</h3><p>RD数据包应该满足如下表的格式，RDETH包含了用于可靠数据包服务的附加传输字段，他仅仅用于Reliable Datagram 数据包中。细节部分见9.3.1。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120154520472.png" alt="RDETH" title="">
                </div>
                <div class="image-caption">RDETH</div>
            </figure>
<h3 id="RDMA-Extended-transport-header-RETH-16-Bytes"><a href="#RDMA-Extended-transport-header-RETH-16-Bytes" class="headerlink" title="RDMA Extended transport header(RETH)-16 Bytes"></a>RDMA Extended transport header(RETH)-16 Bytes</h3><p>由支持RDMA操作的InfiniBand设备生成的数据包应该符合如下表的RETH数据包包头格式。</p>
<p>在RETH中包含了RDMA操作的其他传输字段。RETH仅仅存在于RDMA请求的第一个数据包中。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120155040687.png" alt="RETH" title="">
                </div>
                <div class="image-caption">RETH</div>
            </figure>
<p>细节见9.3.3；</p>
<h3 id="Atomic-Extended-Transport-Header-AtomicETH-28-Bytes"><a href="#Atomic-Extended-Transport-Header-AtomicETH-28-Bytes" class="headerlink" title="Atomic Extended Transport Header(AtomicETH)-28 Bytes"></a>Atomic Extended Transport Header(AtomicETH)-28 Bytes</h3><p>由支持原子操作的InifiniBand设备生成的数据包应该符合下表的AtomicETH的数据包包头格式。</p>
<p>AtomicETH中包含了额外的用于原子数据包的传输字段。数据包的BTH部分的Opcode字段指示了该数据包是否是Atomic packets(原子数据包)。AtomicETH只出现于Atomic packets里面。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120155521892.png" alt="AtomicETH" title="">
                </div>
                <div class="image-caption">AtomicETH</div>
            </figure>
<p>细节见9.3.4</p>
<h3 id="XRC-Extended-Transport-Header-XRCETH"><a href="#XRC-Extended-Transport-Header-XRCETH" class="headerlink" title="XRC Extended Transport Header(XRCETH)"></a>XRC Extended Transport Header(XRCETH)</h3><p>XRC Extended Transport Header (XRCETH) contains the Destination XRC SRQ identifier.</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120155612468.png" alt="XRCETH" title="">
                </div>
                <div class="image-caption">XRCETH</div>
            </figure>
<h3 id="ACK-Extended-Transport-Header-AETH-4-Bytes"><a href="#ACK-Extended-Transport-Header-AETH-4-Bytes" class="headerlink" title="ACK Extended Transport Header(AETH)-4 Bytes"></a>ACK Extended Transport Header(AETH)-4 Bytes</h3><p>AETH包含了ACK数据包的额外的传输字段。AETH只会出现在Acknowledge, RDMA<br>READ Response First, RDMA READ Response Last, and RDMA READ Response Only packets,这些包是由BTH头的Opcode字段指示的。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120161302307.png" alt="AETH" title="">
                </div>
                <div class="image-caption">AETH</div>
            </figure>
<p>细节见9.3.5</p>
<h3 id="Atomic-ACK-Extended-Transport-Header-AtomicAckETH-8-Bytes"><a href="#Atomic-ACK-Extended-Transport-Header-AtomicAckETH-8-Bytes" class="headerlink" title="Atomic ACK Extended Transport Header(AtomicAckETH)-8 Bytes"></a>Atomic ACK Extended Transport Header(AtomicAckETH)-8 Bytes</h3><p>AtomicAckETH仅仅出现在Atomic-Acknowledge数据包中，这也是由BTH中的Opcode字段指示的。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120161926327.png" alt="AtomicAckETH" title="">
                </div>
                <div class="image-caption">AtomicAckETH</div>
            </figure>
<p>细节见9.3.5.3</p>
<h3 id="Immediate-Data-Extended-Transport-Header-ImmDt-4-Bytes"><a href="#Immediate-Data-Extended-Transport-Header-ImmDt-4-Bytes" class="headerlink" title="Immediate Data Extended Transport Header(ImmDt)-4 Bytes"></a>Immediate Data Extended Transport Header(ImmDt)-4 Bytes</h3><p>ImmDt包含了放置在receive Completion Queue Element(CQE)中的额外数据。ImmDt仅仅出现在Send 或者RDMA-Write with Immediate Data数据包中。这也是由BTH中的Opcode字段指示的。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120162322487.png" alt="ImmDt" title="">
                </div>
                <div class="image-caption">ImmDt</div>
            </figure>
<p>细节见9.3.6</p>
<h3 id="Invalidate-Extended-Transport-Header-IETH-4-Bytes"><a href="#Invalidate-Extended-Transport-Header-IETH-4-Bytes" class="headerlink" title="Invalidate Extended Transport Header(IETH)-4 Bytes"></a>Invalidate Extended Transport Header(IETH)-4 Bytes</h3><p>IETH 包含了一个<code>R_key</code>,which is used by the responder to invalidate a memory region or memory window once it receives and executes the SEND with Invalidate request.<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120162703075.png" alt="IETH" title="">
                </div>
                <div class="image-caption">IETH</div>
            </figure></p>
<p>细节见9.3.7</p>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p>PYLD包含了端到端的应用数据。它不会出现在RDMA Read Requests, Acknowledge,CmpSwp, FetchAdd, and Atomic Acknowledge packets里面，只会出现在其他类的op-codes 包里面。</p>
<p>Payload的长度是[0,MTU]；</p>
<p>除了最后一个数据包之外，需要携带有效负载的数据包应该填充到完整MTU大小。</p>
<p>在使用InfiniBand传输的数据包中，数据包里面应该包含0-3字节的Pad字段，用于将有效负载与4字节背书对齐。Pad字段的长度应该在BTH中的PadCnt部分注明。</p>
<h3 id="Invariant-CRC"><a href="#Invariant-CRC" class="headerlink" title="Invariant CRC"></a>Invariant CRC</h3><p>ICRC包含了从源到目的地数据包中不会更改的字段。它只出现在IBA packets中，不会出现在Raw Packets里面。</p>
<p>细节见7.8.1</p>
<h3 id="Variant-CRC"><a href="#Variant-CRC" class="headerlink" title="Variant CRC"></a>Variant CRC</h3><p>包含了链接到链接之间可变的字段，VCRC出现在所有的包里面，包含了IBA以及Raw Packets。</p>
<h2 id="Raw-Packets"><a href="#Raw-Packets" class="headerlink" title="Raw Packets"></a>Raw Packets</h2><p>略。</p>
<h2 id="IBA-Packets-案例"><a href="#IBA-Packets-案例" class="headerlink" title="IBA Packets 案例"></a>IBA Packets 案例</h2><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221120163518952.png" alt="IBA Packets 案例" title="">
                </div>
                <div class="image-caption">IBA Packets 案例</div>
            </figure>
<p>To be done(抓包的实际案例)</p>
<h1 id="ANNEX-A16：RoCE协议"><a href="#ANNEX-A16：RoCE协议" class="headerlink" title="ANNEX A16：RoCE协议"></a>ANNEX A16：RoCE协议</h1><h2 id="RoCE协议的目标"><a href="#RoCE协议的目标" class="headerlink" title="RoCE协议的目标"></a>RoCE协议的目标</h2><ol>
<li>在二层以太网提供RDMA服务</li>
<li>保持现有的动词定义以及相应实现的合规性</li>
<li>维护基本规范中定义的现有内存管理范例</li>
<li>维护现有的InfiniBand传输架构，包括RC,UC,UD,RD和XRC服务以及原子操作</li>
</ol>
<h2 id="RoCE格式"><a href="#RoCE格式" class="headerlink" title="RoCE格式"></a>RoCE格式</h2><p>RoCE与前面第五章定义的现有IB数据包有相同的布局与定义，除了以下部分：</p>
<ol>
<li>每一个RoCE数据包都有GRH。</li>
<li>每一个RoCE数据包都包含一个MAC头来代替IB的LRH。MAC头的目的是提供有关数据包源和目标的信息来让底层网络（以太网）通过子网能够成功交换数据包。</li>
<li>每一个RoCE数据包都包含为以太网帧定义的 FCS。</li>
</ol>
<p>RoCE数据包格式如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221119204506174.png" alt="RoCE数据包格式" title="">
                </div>
                <div class="image-caption">RoCE数据包格式</div>
            </figure>
<p>另外：</p>
<ol>
<li>MACheader中EtherType的字段应该是0x8915，并且DMAC和SMAC字段应该填充RoCE数据包的L2目标和L2源端口的相应MAC地址。</li>
<li>RoCE数据包不得包含变体的CRC。RoCE数据包应该包含适用于所用以太网网络的FCS。</li>
<li>每一个RoCE数据包应该有一个有效的GRH。</li>
</ol>
<h1 id="ANNEX-A17：RoCEv2"><a href="#ANNEX-A17：RoCEv2" class="headerlink" title="ANNEX A17：RoCEv2"></a>ANNEX A17：RoCEv2</h1><h2 id="RoCE简介"><a href="#RoCE简介" class="headerlink" title="RoCE简介"></a>RoCE简介</h2><p>RDMA over Converged Ethernet (RoCE)是一个InfiniBand标准用于保证在以太网上的InifiniBand传输。RoCE保留了InfiniBand动词语义以及传输和网络协议，把InfiniBand 链路层以及物理层的部分替换成了以太网的那些部分。RoCE的网络管理基础架构也是以太网的。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221119200915736.png" alt="协议栈比较" title="">
                </div>
                <div class="image-caption">协议栈比较</div>
            </figure>
<p>RoCE的包格式如下图所示，它的问题在于没有包含以太网头，因此只能在以太网L2域内提供RDMA服务。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221119201022846.png" alt="RoCE包格式" title="">
                </div>
                <div class="image-caption">RoCE包格式</div>
            </figure>
<h2 id="RoCEv2（IP-Routable-RoCE）"><a href="#RoCEv2（IP-Routable-RoCE）" class="headerlink" title="RoCEv2（IP Routable RoCE）"></a>RoCEv2（IP Routable RoCE）</h2><p>RoCEv2是RoCE协议的拓展版本，主要是对RoCE数据包格式进行了修改：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/picture/image-20221119202229290.png" alt="RoCEv2包格式" title="">
                </div>
                <div class="image-caption">RoCEv2包格式</div>
            </figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li>IB Specification Vol 1-Release-1.5-2021-08-06b</li>
</ol>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2022-11-20T08:43:41.853Z" itemprop="dateUpdated">2022-11-20 16:43:41</time>
</span><br>


        
        Link：<a href="/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/" target="_blank" rel="external">http://tyler-ytr.github.io/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/</a>
        
    </div>
    
    <footer>
        <a href="http://Tyler-ytr.github.io">
            <img src="/img/Tyler.png" alt="Tyler-yin">
            Tyler-yin
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RDMA/" rel="tag">RDMA</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://tyler-ytr.github.io/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/&title=《InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)》 — Tyler-yin's blog&pic=http://Tyler-ytr.github.io/img/Tyler.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://tyler-ytr.github.io/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/&title=《InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)》 — Tyler-yin's blog&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://tyler-ytr.github.io/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)》 — Tyler-yin's blog&url=http://tyler-ytr.github.io/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/&via=http://Tyler-ytr.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://tyler-ytr.github.io/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2022/12/19/RDMA%E5%8E%9F%E8%AF%AD%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Infiniband Network Architecture 阅读笔记</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2022/11/17/C-%E5%90%84%E7%B1%BB%E9%A2%98%E7%9B%AE%E6%95%B4%E7%90%86/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">C++各类题目整理</h4>
      </a>
    </div>
  
</nav>



    











    <!-- Valine Comments -->
    <div class="comments vcomment" id="comments"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            el: '#comments',
            notify: 'true' == 'true',
            verify: 'false' == 'true',
            appId: "NoLhoWnmbSW89zV4zc04RPwx-gzGzoHsz",
            appKey: "SSdRGaHcdjoKc7cJJpOlJIqJ",
            avatar: "mm",
            placeholder: "Just go go",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->










</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>This blog is licensed under a <a rel="license noopener" href="https://creativecommons.org/licenses/by/4.0/" target="_blank">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Tyler-yin &copy; 2015 - 2024</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://tyler-ytr.github.io/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/&title=《InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)》 — Tyler-yin's blog&pic=http://Tyler-ytr.github.io/img/Tyler.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://tyler-ytr.github.io/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/&title=《InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)》 — Tyler-yin's blog&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://tyler-ytr.github.io/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《InfiniBand 数据包格式，ROCE 以及ROCEV2 (IP ROUTABLE ROCE)》 — Tyler-yin's blog&url=http://tyler-ytr.github.io/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/&via=http://Tyler-ytr.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://tyler-ytr.github.io/2022/11/19/InifiniBand%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADL0lEQVR42u3awY7iQAwEUP7/p3evI42AKjusSO/LCZFM0q85eFzO4xEff14eP6/5ff3v++R3Tp74+56XHdjY2Ng3YW8e8Iz9+inJ98k6X2/3s+uxsbGxT2U/e0zOy8tV8qyk1G3Who2Njf0/s9uClDcwyUZgY2NjY19VwJK2JG9dZoHRbBOxsbGxT2VfVSTas7NI659madjY2Nhfz86not//+SPzbWxsbOwvZs9elEnamHYY3BanlQIbGxv7IHa79DYkShaXb1k7PH6zfmxsbOwj2EkAtGkAks3KSZtiGf3O2NjY2Ddk5+DNP/1/Fkc+SG6HCtjY2NjnsdtF5yVkNqa9qqzWU25sbGzsW7E/saCrQqh8JBD9qj+fgo2NjX0QO28/2hFvXgI3o+W8XSkqNjY2Nvat2PnAtY3727Apv9tssPGmbmNjY2Pflj3Ln64aAOwbj03hxMbGxj6DnRSYPELKW5S8pLXj5OELOtjY2Ni3ZbeM2ecLovz1N2+yNGxsbOzbsj/x4M2GzuKtdmCAjY2NfSp70wa00VI74p2NfqNBLzY2NvbN2XkhyW+dh0T5GmZj4zcxEzY2NvZx7HaJ7WhhFkK1rU5+FhsbG/skdhvZtw3DpkC2P0/bPmFjY2OfwV79Q78IlWaD4VlzUndg2NjY2LdiXxXrzMrM7A3J2TfY2NjY57E3i1v1PaPtbjeoeFMJGxsb+7bs/EXJdmDQLqsdA3wkS8PGxsa+IbsNifJoqe6E1rFUcRYbGxv7IPamUD2CY7bER3kMSy82Njb2Qey2CM3innxB+yFxMejFxsbGPoK9LxtJs5Hj84FEHjA9HfdiY2NjH8RuS0sb32+K3OtrZluAjY2NfR571rVs+p62zdj0EdjY2Ninsmfv+OSk2dn2r+qRAzY2NvZB7FXdW8c9w9nFKK4abgE2Njb2Tdh50Wqv37wMlI8Q8pcvi+qNjY2NfUP2LLLPzyabmEdIbeCFjY2Njb1/rSfZrDYemo17sbGxsbHzUvS6dckDqbzUFWUMGxsb+zh2u7irRr/tRuT3uWw8gI2Njf317NnrMnt2G0XlP1LyU2FjY2Mfwf4L68zPq9bEtYkAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>



<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" async></script>




<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '＞﹏＜';
            clearTimeout(titleTime);
        } else {
            document.title = '~\(≧▽≦)/~';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>


</body>
</html>
